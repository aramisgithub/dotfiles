#!/usr/bin/env bash

#
# Basics
#

doc=$(cat $HOME/.currentfile)

# Delete old PDF
rm $doc.pdf

#
# Modify before convert
#

# Abbreviations

# Run some regexes to convert abbreviations and acronyms into small caps. If
# a different kind of formatting for abbreviations/acronyms is desired, the
# \abbr command can be redefined.

# Matches any acceptable character (i.e. any character that will not be found in
# code that has to be capitalised (e.g. chemical equations)) with a space after,
# plus the abbreviation
sed -E 's/([A-Za-z0-9.,:?;\)\"\x27}|#-] )([A-Z][A-Z]+)/\1\\abbr{\2}/g' $doc > $doc.mod1

# Matches abbreviation at the start of a line
sed -E 's/^([A-Z][A-Z]+)/\\abbr{\1}/g' $doc.mod1 > $doc.mod2

# Matches abbreviation after parentheses
sed -E 's/\(([A-Z][A-Z]+)/\(\\abbr{\1}/g' $doc.mod2 > $doc.mod3

# Misc

# Use the best ampersand for titling (in this context, headings)
sed -E 's/^(#+)(.*)&(.*)/\1\2\\oldand{}\3/g' $doc.mod3 > $doc.finalmod

#
# Convert
#

# Convert the various document types into temporary tex files
if [ $1 = "report" ]; then
  pandoc -f markdown -t latex $doc.finalmod -o $doc.mod1.tex --template=$HOME/code/argonclass/pandoc/report.tex --top-level-division=chapter
elif [ $1 = "article" ]; then
  pandoc -f markdown -t latex $doc.finalmod -o $doc.mod1.tex --template=$HOME/code/argonclass/pandoc/article.tex --top-level-division=section
elif [ $1 = "pres" ]; then
  pandoc -t beamer $doc.finalmod -o $doc.mod1.tex --template=$HOME/code/argonclass/pandoc/pres.tex --slide-level=2
else
  echo "Specified document type not valid. Try using report, article, or pres."
fi

#
# Modify after convert
#

# Delete pandoc's code that prohibits custom labels on ordered lists. You can
# comment this part out if you use the many different kinds of list in pandoc's
# markdown; such as i. ii. iii. and a. b. c
sed '/\\def\\labelenumi/d' $doc.mod1.tex > $doc.mod2.tex
sed '/\\tightlist/d' $doc.mod2.tex > $doc.tex

#
# Clean up
#

# Remove all the temporary files that this script creates
rm $doc.mod*
rm $doc.finalmod*

#
# Compile
#

# Compile using texshop
osascript ~/dotfiles/home/bin/bin/texshop.scpt $doc.tex
